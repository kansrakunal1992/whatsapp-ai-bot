<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Preview | AI WhatsApp Automation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            width: 100%;
            display: flex;
            gap: 30px;
        }
        
        .left-panel {
            width: 300px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 20px;
            transition: all 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .left-panel.collapsed {
            width: 50px;
            padding: 20px 10px;
        }
        
        .left-panel.collapsed .panel-content {
            display: none;
        }
        
        .toggle-panel {
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-bottom: 15px;
        }
        
        .panel-content h3 {
            color: #4CAF50;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .qa-list {
            list-style: none;
        }
        
        .qa-item {
            padding: 10px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .qa-item:hover {
            background: #e8f5e9;
        }
        
        .qa-item .question {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .qa-item .answer {
            font-size: 0.9rem;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .preview-section {
            flex: 1;
            max-width: 800px;
        }
        
        h1 {
            color: #4CAF50;
            margin-bottom: 15px;
            text-align: center;
        }
        
        p.subtitle {
            color: #666;
            margin-bottom: 30px;
            text-align: center;
        }
        
        /* [Rest of your existing CSS remains unchanged...] */
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel with Q&A List -->
        <div class="left-panel" id="leftPanel">
            <button class="toggle-panel" id="togglePanel">-</button>
            <div class="panel-content">
                <h3>Your Q&A Responses</h3>
                <ul class="qa-list" id="qaList">
                    <!-- Will be populated by JavaScript -->
                </ul>
            </div>
        </div>
        
        <!-- Preview Section -->
        <div class="preview-section">
            <h1>Chatbot Preview</h1>
            <p class="subtitle">Test your AI WhatsApp bot responses</p>
            
            <!-- Navigation Buttons -->
            <div class="nav-buttons">
                <a href="customize-qa-responses.html" class="nav-btn">← Back to Customization</a>
                <a href="LandingPage.html" class="nav-btn">Home Page</a>
            </div>
            
            <!-- Phone Frame with Interactive Chat -->
            <div class="phone">
                <div class="screen">
                    <div class="chat-header">
                        <button class="back-btn">←</button>
                        AI WhatsApp Bot
                    </div>
                    <div class="chat-container" id="chatContainer">
                        <!-- Initial messages will be added by JavaScript -->
                    </div>
                    <div class="input-area">
                        <input type="text" class="message-input" placeholder="Type a message..." id="messageInput">
                        <button class="send-btn" id="sendBtn">→</button>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="customize-btn" id="customizeBtn">Customize Responses</button>
                <button class="deploy-btn" id="deployBtn">Deploy My Bot</button>
            </div>
        </div>
    </div>

    <script>
        // Enhanced QA loading with Neon DB fallback
        async function loadQA() {
            try {
                const businessInfo = JSON.parse(localStorage.getItem('businessInfo'));
                if (!businessInfo?.whatsappNumber) {
                    console.log("No business info found in localStorage");
                    return {};
                }

                const response = await fetch(`/api/get-qa?whatsappNumber=${encodeURIComponent(businessInfo.whatsappNumber)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log("Loaded QA from DB:", data);
                return data;
            } catch (error) {
                console.error("Failed to load from DB, using localStorage fallback:", error);
                const fallbackData = JSON.parse(localStorage.getItem('customizedQA') || '{}');
                return fallbackData;
            }
        }

        // Business context with enhanced defaults
        function getBusinessContext() {
            const defaultContext = {
                type: "business",
                services: ["service 1", "service 2"],
                priceRange: "₹X-₹Y",
                location: "Your location",
                workingHours: "Your working hours"
            };
            
            try {
                const storedContext = JSON.parse(localStorage.getItem('businessInfo')) || {};
                return {
                    ...defaultContext,
                    ...storedContext
                };
            } catch (e) {
                console.error("Error parsing business context:", e);
                return defaultContext;
            }
        }

        // Initialize default responses with business context
        function getDefaultResponses(language, businessContext) {
            const templates = {
                "en": {
                    "What are your charges?": `Our prices range from ${businessContext.priceRange}.`,
                    "What are your working hours?": `We're open ${businessContext.workingHours}.`,
                    "Where are you located?": `We're located at ${businessContext.location}.`,
                    "What services do you offer?": `We offer ${businessContext.services?.join(", ") || 'various services'}.`,
                    "Do I need an appointment?": `Appointments are recommended but walk-ins are welcome.`,
                    "Hello": "Hello! How can I help you today?"
                },
                "hi": {
                    "Aapke charges kya hain?": `Humare prices ${businessContext.priceRange} hain.`,
                    "Aapke working hours kya hain?": `Hum ${businessContext.workingHours} tak khule hain.`,
                    "Aap kahan sthit hain?": `Hum ${businessContext.location} par sthit hain.`,
                    "Aap kaun si services offer karte hain?": `Hum ${businessContext.services?.join(", ") || 'various services'} offer karte hain.`,
                    "Kya mujhe appointment ki zaroorat hai?": `Appointments recommend kiye jaate hain lekin walk-ins ka bhi swagat hai.`,
                    "Namaste": "Namaste! Main aapki kaise madad kar sakta hoon?"
                }
            };
            
            return templates[language] || templates["en"];
        }

        // DOM elements
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const customizeBtn = document.getElementById('customizeBtn');
        const deployBtn = document.getElementById('deployBtn');
        const leftPanel = document.getElementById('leftPanel');
        const togglePanel = document.getElementById('togglePanel');
        const qaList = document.getElementById('qaList');

        // Main application state
        const appState = {
            businessContext: getBusinessContext(),
            selectedLanguage: localStorage.getItem('selectedLanguage') || 'en',
            botResponses: {},
            savedQA: {}
        };

        // Initialize the application
        async function init() {
            try {
                // Load QA from DB with localStorage fallback
                appState.savedQA = await loadQA();
                
                // Get default responses based on business context
                const defaultResponses = getDefaultResponses(
                    appState.selectedLanguage, 
                    appState.businessContext
                );
                
                // Combine saved and default responses
                appState.botResponses = {
                    ...defaultResponses,
                    ...appState.savedQA
                };
                
                console.log("Final bot responses:", appState.botResponses);
                
                // Populate Q&A list
                populateQAList();
                
                // Set initial greeting
                const greeting = getGreeting(appState.selectedLanguage);
                addMessage(greeting, 'bot');
                
            } catch (error) {
                console.error("Initialization error:", error);
                addMessage("Failed to load bot configuration. Please try again.", 'bot');
            }
        }

        // [Rest of your existing functions (populateQAList, toggleLeftPanel, addMessage, sendMessage, getBotResponse) remain unchanged...]

        // Event listeners
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        
        customizeBtn.addEventListener('click', () => {
            window.location.href = 'customize-qa-responses.html';
        });
        
        deployBtn.addEventListener('click', () => {
            window.location.href = 'deploy-confirmation.html';
        });
        
        document.querySelector('.back-btn').addEventListener('click', () => {
            window.location.href = 'customize-qa-responses.html';
        });
        
        togglePanel.addEventListener('click', toggleLeftPanel);

        // Initialize the application
        init();

        // Helper function to get language-specific greeting
        function getGreeting(language) {
            switch(language) {
                case 'hi': return "Namaste! Main aapki kaise madad kar sakta hoon?";
                case 'bn': return "Hello! Ami apnar kivabe shahajjo korte pari?";
                default: return "Hello! I'm your AI assistant. How can I help you today?";
            }
        }

        // Enhanced error handling for API calls
        async function safeFetch(url, options) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }
    </script>
</body>
</html>